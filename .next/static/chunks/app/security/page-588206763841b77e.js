(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[369],{464:(e,t,s)=>{"use strict";s.d(t,{DD:()=>y,HP:()=>p,MJ:()=>u,gX:()=>m,hw:()=>h,qb:()=>x});var a=s(5155),i=s(2115),r=s(2108),n=s(5695),c=s(3169);let l=()=>(0,a.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"}),(0,a.jsx)("p",{className:"mt-4 text-gray-600",children:"Loading..."})]})}),o=e=>{let{requiredRole:t,userRole:s}=e;return(0,a.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,a.jsxs)("div",{className:"text-center max-w-md mx-auto p-6",children:[(0,a.jsx)("div",{className:"bg-red-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)("svg",{className:"w-8 h-8 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z"})})}),(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Access Denied"}),(0,a.jsx)("p",{className:"text-gray-600 mb-4",children:"You don't have permission to access this page."}),(0,a.jsxs)("div",{className:"text-sm text-gray-500 mb-6",children:[(0,a.jsxs)("p",{children:["Required role: ",(0,a.jsx)("span",{className:"font-semibold",children:Array.isArray(t)?t.join(" or "):t})]}),(0,a.jsxs)("p",{children:["Your role: ",(0,a.jsx)("span",{className:"font-semibold",children:s||"None"})]})]}),(0,a.jsx)("button",{onClick:()=>window.history.back(),className:"bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 transition-colors",children:"Go Back"})]})})},d=e=>{let{children:t,requiredRole:s=null,requiredRoles:d=null,redirectTo:m="/login",fallback:u=null}=e,{data:x,status:h}=(0,r.useSession)(),{user:y,loading:p,hasRole:f,hasAnyRole:j}=(0,c.As)(),N=(0,n.useRouter)();if((0,i.useEffect)(()=>{if(console.log("\uD83D\uDEE1️ ProtectedRoute: Auth state check:",{session:!!x,status:h,loading:p,userRole:null==y?void 0:y.role,requiredRole:s,requiredRoles:d,userEmail:null==y?void 0:y.email}),"loading"===h||p)return void console.log("\uD83D\uDEE1️ ProtectedRoute: Still loading, waiting...");if(!x||!y){console.log("\uD83D\uDEE1️ ProtectedRoute: Not authenticated, redirecting to login"),N.push(m);return}return s&&(null==y?void 0:y.role)!==s?void console.log("\uD83D\uDEE1️ ProtectedRoute: Role check failed for single role:",{userRole:null==y?void 0:y.role,requiredRole:s}):d&&!d.includes(null==y?void 0:y.role)?void console.log("\uD83D\uDEE1️ ProtectedRoute: Role check failed for multiple roles:",{userRole:null==y?void 0:y.role,requiredRoles:d,includes:d.includes(null==y?void 0:y.role)}):void console.log("\uD83D\uDEE1️ ProtectedRoute: All checks passed, rendering content")},[x,h,p,null==y?void 0:y.role,s,d,N,m]),"loading"===h||p)return u||(0,a.jsx)(l,{});if(!x||!y)return null;let g=d||s;return!g||(d?j(d):f(s))?t:(0,a.jsx)(o,{requiredRole:g,userRole:null==y?void 0:y.role})},m=e=>{let{children:t,...s}=e;return(0,a.jsx)(d,{requiredRoles:["faculty","hod"],...s,children:t})},u=e=>{let{children:t,...s}=e;return(0,a.jsx)(d,{requiredRoles:["security","security_head"],...s,children:t})},x=e=>{let{children:t,...s}=e;return(0,a.jsx)(d,{requiredRole:"security_head",...s,children:t})},h=e=>{let{children:t,...s}=e;return(0,a.jsx)(d,{requiredRole:"admin",...s,children:t})},y=e=>{let{children:t,...s}=e;return(0,a.jsx)(d,{requiredRole:"hod",...s,children:t})},p=e=>{let{children:t,...s}=e;return(0,a.jsx)(d,{...s,children:t})}},842:(e,t,s)=>{Promise.resolve().then(s.bind(s,5163))},5163:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>g});var a=s(5155),i=s(464),r=s(2115),n=s(6418),c=s(4186),l=s(7434),o=s(646),d=s(1243),m=s(1007),u=s(8883),x=s(9420),h=s(9803),y=s(5695),p=s(6826),f=s(3169),j=s(9130);let N=()=>{var e;let[t,s]=(0,r.useState)("scan"),[i,N]=(0,r.useState)(!1),[g,v]=(0,r.useState)(null),[A,b]=(0,r.useState)(!1),w=(0,y.useRouter)(),{user:E}=(0,f.As)(),{notifications:R,unreadCount:S,markAsRead:C,markAllAsRead:k,deleteNotification:T}=(0,j.E$)(),[D,_]=(0,r.useState)([]),[O,I]=(0,r.useState)([]),[M,L]=(0,r.useState)(!0),[P,K]=(0,r.useState)(null);(0,r.useEffect)(()=>{Y(),F()},[]);let Y=async()=>{try{let e=await fetch("/api/security/pending");if(!e.ok)throw Error("Failed to fetch pending handovers");let t=await e.json();_(t.pendingHandovers||[])}catch(e){console.error("Error fetching pending handovers:",e),K("Failed to load pending handovers")}},F=async()=>{try{let e=new Date().toISOString().split("T")[0],t=await fetch("/api/security/scan?date=".concat(e));if(!t.ok)throw Error("Failed to fetch today logs");let s=await t.json();I(s.scanHistory||[]),L(!1)}catch(e){console.error("Error fetching today logs:",e),K("Failed to load today logs"),L(!1)}},q=[{id:"scan",label:"Scan",icon:(0,a.jsx)(n.A,{className:"h-5 w-5"})},{id:"pending",label:"Pending",icon:(0,a.jsx)(c.A,{className:"h-5 w-5"}),badge:D.filter(e=>e.isOverdue).length},{id:"logs",label:"Today Logs",icon:(0,a.jsx)(l.A,{className:"h-5 w-5"})}],$=()=>{N(!0)},z=()=>{b(!0),setTimeout(()=>{v({keyId:"key-001",keyName:"Computer Lab Key",facultyName:"Dr. Smith",action:"collection",timestamp:Date.now()}),b(!1)},2e3)},Z=async()=>{try{let e=await fetch("/api/security/scan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({qrData:g.qrData||JSON.stringify(g),action:g.action})});if(!e.ok)throw Error("Failed to process scan");let t=await e.json();F(),Y(),v(null),console.log("Scan processed successfully:",t)}catch(e){console.error("Error processing scan:",e)}},G=async e=>{try{let t=await fetch("/api/security/pending",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"send-reminder",assignmentId:e.id})});if(!t.ok)throw Error("Failed to send reminder");let s=await t.json();Y(),console.log("Reminder sent successfully:",s)}catch(e){console.error("Error sending reminder:",e)}};return M?(0,a.jsx)("div",{className:"min-h-screen bg-background-secondary flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-security mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-secondary",children:"Loading security dashboard..."})]})}):P?(0,a.jsx)("div",{className:"min-h-screen bg-background-secondary flex items-center justify-center",children:(0,a.jsxs)(p.Zp,{className:"text-center p-8",children:[(0,a.jsx)("div",{className:"text-danger mb-4",children:"⚠️"}),(0,a.jsx)("h3",{className:"text-lg font-semibold text-primary mb-2",children:"Error Loading Dashboard"}),(0,a.jsx)("p",{className:"text-secondary mb-4",children:P}),(0,a.jsx)(p.$n,{onClick:()=>window.location.reload(),children:"Retry"})]})}):(0,a.jsxs)("div",{className:"min-h-screen bg-background-secondary pb-20",children:[(0,a.jsx)(p.Y9,{title:"Security Dashboard",showNotifications:!0,showProfile:!0,onNotificationClick:$,onProfileClick:()=>w.push("/profile"),className:"bg-surface border-b border-default",children:(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(p.$n,{variant:"ghost",size:"sm",onClick:$,icon:(0,a.jsx)(d.A,{className:"h-5 w-5"})}),S>0&&(0,a.jsx)(p.vd,{count:S,size:"sm",type:"danger",className:"absolute -top-2 -right-2"})]}),(0,a.jsx)(p.UW,{})]})}),(0,a.jsx)("div",{className:"px-4 py-6 bg-security/5",children:(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"w-12 h-12 bg-security rounded-full flex items-center justify-center",children:(0,a.jsx)("span",{className:"text-white font-semibold",children:(null==E||null==(e=E.name)?void 0:e.charAt(0))||"S"})}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("h1",{className:"text-xl font-bold text-primary",children:["Welcome, ",(null==E?void 0:E.name)||"Security"]}),(0,a.jsx)("p",{className:"text-secondary",children:"Security Personnel"})]})]})}),(0,a.jsx)("main",{className:"px-4 py-6",children:(()=>{switch(t){case"scan":default:return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)(p.Zp,{role:"security",className:"text-center py-12",children:A?(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-security rounded-full flex items-center justify-center mx-auto animate-pulse",children:(0,a.jsx)(n.A,{className:"h-8 w-8 text-white"})}),(0,a.jsx)("h3",{className:"text-lg font-medium text-primary",children:"Scanning..."}),(0,a.jsx)("p",{className:"text-secondary",children:"Point camera at QR code"})]}):g?(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-success rounded-full flex items-center justify-center mx-auto",children:(0,a.jsx)(o.A,{className:"h-8 w-8 text-white"})}),(0,a.jsx)("h3",{className:"text-lg font-medium text-primary",children:"QR Code Scanned"}),(0,a.jsx)("div",{className:"bg-surface-secondary rounded-lg p-4 text-left",children:(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{children:"Key:"})," ",g.keyName]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{children:"Faculty:"})," ",g.facultyName]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{children:"Action:"})," ",g.action]})]})}),(0,a.jsxs)("div",{className:"flex space-x-3",children:[(0,a.jsx)(p.$n,{variant:"ghost",onClick:()=>v(null),className:"flex-1",children:"Cancel"}),(0,a.jsxs)(p.$n,{variant:"primary",onClick:Z,className:"flex-1",children:["Confirm ",g.action]})]})]}):(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-security/20 rounded-full flex items-center justify-center mx-auto",children:(0,a.jsx)(n.A,{className:"h-8 w-8 text-security"})}),(0,a.jsx)("h3",{className:"text-lg font-medium text-primary",children:"QR Scanner"}),(0,a.jsx)("p",{className:"text-secondary mb-6",children:"Scan faculty QR codes for key collection or deposit"}),(0,a.jsx)(p.$n,{variant:"primary",size:"lg",onClick:z,icon:(0,a.jsx)(n.A,{className:"h-5 w-5"}),children:"Start Scanning"})]})}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)(p.Zp,{role:"security",padding:"sm",className:"text-center",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-success",children:O.filter(e=>"collection"===e.type).length}),(0,a.jsx)("div",{className:"text-sm text-secondary",children:"Collections Today"})]}),(0,a.jsxs)(p.Zp,{role:"security",padding:"sm",className:"text-center",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-info",children:O.filter(e=>"deposit"===e.type).length}),(0,a.jsx)("div",{className:"text-sm text-secondary",children:"Deposits Today"})]})]})]});case"pending":return(0,a.jsx)("div",{className:"space-y-4",children:0===D.length?(0,a.jsxs)(p.Zp,{className:"text-center py-12",children:[(0,a.jsx)(o.A,{className:"h-12 w-12 text-success mx-auto mb-4"}),(0,a.jsx)("h3",{className:"text-lg font-medium text-primary mb-2",children:"All Clear!"}),(0,a.jsx)("p",{className:"text-secondary",children:"No pending key handovers"})]}):D.map(e=>(0,a.jsxs)(p.Zp,{role:"security",className:e.isOverdue?"border-l-4 border-l-danger":"",children:[(0,a.jsx)("div",{className:"flex items-start justify-between mb-3",children:(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2 mb-1",children:[(0,a.jsx)("h3",{className:"font-semibold text-primary",children:e.keyName}),e.isOverdue&&(0,a.jsxs)(p.Ex,{variant:"danger",size:"sm",children:[(0,a.jsx)(d.A,{className:"h-3 w-3 mr-1"}),"Overdue"]})]}),(0,a.jsx)("p",{className:"text-sm text-secondary",children:e.labName})]})}),(0,a.jsxs)("div",{className:"space-y-2 text-sm text-secondary mb-4",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(m.A,{className:"h-3 w-3"}),(0,a.jsx)("span",{children:e.facultyName})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(u.A,{className:"h-3 w-3"}),(0,a.jsx)("span",{children:e.facultyEmail})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(c.A,{className:"h-3 w-3"}),(0,a.jsxs)("span",{children:["Due: ",e.dueDate.toLocaleDateString(),e.isOverdue&&(0,a.jsxs)("span",{className:"text-danger ml-1",children:["(",Math.floor((Date.now()-e.dueDate)/864e5)," days overdue)"]})]})]})]}),(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)(p.$n,{variant:"ghost",size:"sm",onClick:()=>G(e),icon:(0,a.jsx)(u.A,{className:"h-3 w-3"}),className:"flex-1",children:"Send Reminder"}),(0,a.jsx)(p.$n,{variant:"ghost",size:"sm",icon:(0,a.jsx)(x.A,{className:"h-3 w-3"}),className:"flex-1",children:"Call Faculty"})]})]},e.id))});case"logs":return(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h3",{className:"font-semibold text-primary",children:"Today's Activity"}),(0,a.jsxs)(p.Ex,{variant:"info",children:[O.length," transactions"]})]}),0===O.length?(0,a.jsxs)(p.Zp,{className:"text-center py-12",children:[(0,a.jsx)(l.A,{className:"h-12 w-12 text-muted mx-auto mb-4"}),(0,a.jsx)("h3",{className:"text-lg font-medium text-primary mb-2",children:"No activity today"}),(0,a.jsx)("p",{className:"text-secondary",children:"Key transactions will appear here"})]}):O.map(e=>(0,a.jsx)(p.Zp,{role:"security",children:(0,a.jsxs)("div",{className:"flex items-start space-x-3",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center ".concat("collection"===e.type?"bg-success/20":"bg-info/20"),children:"collection"===e.type?(0,a.jsx)(h.A,{className:"h-5 w-5 text-success"}):(0,a.jsx)(o.A,{className:"h-5 w-5 text-info"})}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsx)("h4",{className:"font-medium text-primary",children:e.keyName}),(0,a.jsx)(p.Ex,{variant:"collection"===e.type?"success":"info",size:"sm",children:"collection"===e.type?"Collected":"Deposited"})]}),(0,a.jsx)("p",{className:"text-sm text-secondary",children:e.facultyName}),(0,a.jsxs)("p",{className:"text-xs text-muted",children:[e.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})," • ",(e=>{let t=Math.floor((new Date-e)/6e4);return t<1?"Just now":t<60?"".concat(t,"m ago"):t<1440?"".concat(Math.floor(t/60),"h ago"):"".concat(Math.floor(t/1440),"d ago")})(e.timestamp)]})]})]})},e.id))]})}})()}),(0,a.jsx)(p.im,{items:q,activeItem:t,onItemClick:e=>{s(e.id)},variant:"security"}),(0,a.jsx)(p.vq,{isOpen:i,onClose:()=>N(!1),notifications:R,userRole:"security",onMarkAsRead:C,onMarkAllAsRead:k,onDeleteNotification:T})]})};function g(){return(0,a.jsx)(i.MJ,{children:(0,a.jsx)(N,{})})}},9130:(e,t,s)=>{"use strict";s.d(t,{E$:()=>d,ph:()=>o});var a=s(5155),i=s(2115);let r=(0,i.createContext)(),n={KEY_OVERDUE:{type:"alert",priority:"high",roles:["faculty","hod","security_head"],autoExpire:!1},KEY_ASSIGNMENT:{type:"info",priority:"medium",roles:["faculty"],autoExpire:!0,expireAfter:864e5},KEY_DELEGATION:{type:"info",priority:"medium",roles:["faculty","hod"],autoExpire:!0,expireAfter:6048e5},SECURITY_ALERT:{type:"alert",priority:"high",roles:["security","security_head"],autoExpire:!1},SYSTEM_MAINTENANCE:{type:"warning",priority:"medium",roles:["faculty","security","hod","security_head"],autoExpire:!0,expireAfter:72e5},REPORT_READY:{type:"success",priority:"low",roles:["hod","security_head"],autoExpire:!0,expireAfter:6048e5}},c=(e,t)=>{switch(t.type){case"ADD_NOTIFICATION":return{...e,notifications:[t.payload,...e.notifications],unreadCount:e.unreadCount+1};case"MARK_AS_READ":return{...e,notifications:e.notifications.map(e=>e.id===t.payload?{...e,read:!0}:e),unreadCount:Math.max(0,e.unreadCount-1)};case"MARK_ALL_AS_READ":return{...e,notifications:e.notifications.map(e=>({...e,read:!0})),unreadCount:0};case"DELETE_NOTIFICATION":let s=e.notifications.find(e=>e.id===t.payload);return{...e,notifications:e.notifications.filter(e=>e.id!==t.payload),unreadCount:s&&!s.read?Math.max(0,e.unreadCount-1):e.unreadCount};case"CLEAR_EXPIRED":let a=Date.now(),i=e.notifications.filter(e=>!e.expiresAt||e.expiresAt>a),r=e.notifications.filter(e=>e.expiresAt&&e.expiresAt<=a&&!e.read).length;return{...e,notifications:i,unreadCount:Math.max(0,e.unreadCount-r)};case"SET_NOTIFICATIONS":let n=t.payload.filter(e=>!e.read).length;return{...e,notifications:t.payload,unreadCount:n};default:return e}},l={notifications:[],unreadCount:0},o=e=>{let{children:t,userRole:s}=e,[o,d]=(0,i.useReducer)(c,l);(0,i.useEffect)(()=>{let e=setInterval(()=>{d({type:"CLEAR_EXPIRED"})},6e4);return()=>clearInterval(e)},[]);let m=e=>{let t=n[e.notificationType]||{type:"info",priority:"medium",roles:["faculty","security","hod","security_head"],autoExpire:!1};if(!t.roles.includes(s))return;let a={id:"notif_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),title:e.title,message:e.message,type:t.type,priority:t.priority,category:e.category||"General",timestamp:new Date,read:!1,expiresAt:t.autoExpire?Date.now()+t.expireAfter:null,data:e.data||{}};d({type:"ADD_NOTIFICATION",payload:a}),"granted"===Notification.permission&&"high"===t.priority&&new Notification(a.title,{body:a.message,icon:"/VNRVJIETLOGO.png",tag:a.id})},u=async()=>"Notification"in window&&"default"===Notification.permission?"granted"===await Notification.requestPermission():"granted"===Notification.permission,x={notifications:o.notifications,unreadCount:o.unreadCount,addNotification:m,markAsRead:e=>{d({type:"MARK_AS_READ",payload:e})},markAllAsRead:()=>{d({type:"MARK_ALL_AS_READ"})},deleteNotification:e=>{d({type:"DELETE_NOTIFICATION",payload:e})},requestNotificationPermission:u,...{keyOverdueReminder:(e,t)=>m({notificationType:"KEY_OVERDUE",title:"Key Return Reminder",message:"".concat(e," is ").concat(t," day(s) overdue. Please return immediately."),category:"Key Management",data:{keyName:e,daysOverdue:t}}),keyAssigned:(e,t)=>m({notificationType:"KEY_ASSIGNMENT",title:"New Key Assignment",message:"You have been assigned access to ".concat(e," (").concat(t,")."),category:"Key Management",data:{keyName:e,labName:t}}),keyDelegated:(e,t,s)=>m({notificationType:"KEY_DELEGATION",title:"Key Access Shared",message:"".concat(t," has shared ").concat(e," access with you for ").concat(s,"."),category:"Key Sharing",data:{keyName:e,fromFaculty:t,duration:s}}),overdueAlert:(e,t,s)=>m({notificationType:"SECURITY_ALERT",title:"Overdue Key Alert",message:"".concat(e," is ").concat(s," day(s) overdue. Faculty: ").concat(t),category:"Security Alert",data:{keyName:e,facultyName:t,daysOverdue:s}}),departmentReport:(e,t)=>m({notificationType:"REPORT_READY",title:"Department Report Ready",message:"".concat(e," report for ").concat(t," is ready for review."),category:"Reports",data:{reportType:e,period:t}}),maintenanceAlert:(e,t)=>m({notificationType:"SYSTEM_MAINTENANCE",title:"Scheduled Maintenance",message:"System maintenance scheduled for ".concat(e,". Duration: ").concat(t,"."),category:"System",data:{startTime:e,duration:t}})}};return(0,a.jsx)(r.Provider,{value:x,children:t})},d=()=>{let e=(0,i.useContext)(r);if(!e)throw Error("useNotifications must be used within a NotificationProvider");return e}}},e=>{e.O(0,[96,826,358],()=>e(e.s=842)),_N_E=e.O()}]);