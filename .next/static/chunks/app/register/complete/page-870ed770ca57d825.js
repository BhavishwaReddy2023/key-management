(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[368],{3105:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>i});var o=t(5155),s=t(2115),l=t(2108),a=t(5695),n=t(3169);function i(){let{data:e,status:r,update:t}=(0,l.useSession)(),i=(0,a.useRouter)(),c=(0,a.useSearchParams)(),{user:u,loading:d,navigateToDashboard:h,getDashboardUrl:g}=(0,n.As)(),[m,p]=(0,s.useState)(!0),[f,x]=(0,s.useState)(null);(0,s.useEffect)(()=>{(async()=>{if("loading"!==r&&!d)try{if(!e){x("Authentication failed. Please try again."),setTimeout(()=>i.push("/register"),2e3);return}let r=c.get("role"),o=localStorage.getItem("pendingUserRole")||sessionStorage.getItem("pendingUserRole"),s=null;try{let e=localStorage.getItem("pendingUserRoleData");if(e){let r=JSON.parse(e);Date.now()-r.timestamp<6e5&&(s=r.role)}}catch(e){console.warn("Failed to parse stored role data:",e)}let a=r||s||o||"faculty";if(console.log("\uD83C\uDFAF Registration completion:",{email:e.user.email,selectedRole:a,roleFromUrl:r,roleFromStorage:o,roleFromData:s,sessionRole:e.user.role}),(await y(e.user.email,a)).success){console.log("✅ Role successfully updated to:",a),localStorage.removeItem("pendingUserRole"),sessionStorage.removeItem("pendingUserRole"),localStorage.removeItem("pendingUserRoleData"),document.cookie="pendingUserRole=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT",console.log("\uD83D\uDD04 Triggering session refresh..."),await t({trigger:"update"});try{await fetch("/api/auth/refresh",{method:"POST"})}catch(e){console.warn("Custom refresh failed:",e)}await (0,l.getSession)();let e=0,r=async()=>{var t,o;let s=await (0,l.getSession)();console.log("\uD83D\uDD0D Session check attempt ".concat(e+1,":"),{role:null==s||null==(t=s.user)?void 0:t.role,expected:a}),(null==s||null==(o=s.user)?void 0:o.role)===a?(console.log("✅ Session updated successfully"),p(!1),h()):e>=5?(console.log("⚠️ Max attempts reached, forcing page reload to refresh session"),window.location.href=g(a)):(e++,setTimeout(r,500))};setTimeout(r,1e3)}else throw Error("Failed to update user role")}catch(e){console.error("Registration completion error:",e),x("Failed to complete registration. Please try again."),p(!1)}})()},[e,r,d,c,i,h]);let y=async(e,r)=>{try{console.log("\uD83D\uDD04 Updating role for ".concat(e," to ").concat(r));let t=await fetch("/api/user/update-role",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,role:r})}),o=await t.json();if(!t.ok)throw console.error("❌ Role update failed:",o),Error(o.error||"Failed to update user role");return console.log("✅ Role update successful:",o),{success:!0,data:o}}catch(e){return console.error("❌ Error updating user role:",e),{success:!1,error:e.message}}};return f?(0,o.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-red-50 to-red-100 flex items-center justify-center px-4",children:(0,o.jsx)("div",{className:"max-w-md w-full text-center",children:(0,o.jsxs)("div",{className:"bg-white py-8 px-6 shadow-xl rounded-lg",children:[(0,o.jsx)("div",{className:"mx-auto h-20 w-20 bg-red-600 rounded-full flex items-center justify-center mb-6",children:(0,o.jsx)("svg",{className:"h-10 w-10 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),(0,o.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Registration Failed"}),(0,o.jsx)("p",{className:"text-gray-600 mb-6",children:f}),(0,o.jsx)("button",{onClick:()=>i.push("/register"),className:"w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors",children:"Try Again"})]})})}):(0,o.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 flex items-center justify-center px-4",children:(0,o.jsx)("div",{className:"max-w-md w-full text-center",children:(0,o.jsxs)("div",{className:"bg-white py-8 px-6 shadow-xl rounded-lg",children:[(0,o.jsx)("div",{className:"mx-auto h-20 w-20 bg-green-600 rounded-full flex items-center justify-center mb-6",children:m?(0,o.jsx)("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-white"}):(0,o.jsx)("svg",{className:"h-10 w-10 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),(0,o.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:m?"Completing Registration...":"Registration Complete!"}),(0,o.jsx)("p",{className:"text-gray-600 mb-6",children:m?"Please wait while we set up your account with the selected role.":"Your account has been created successfully. Redirecting to your dashboard..."}),e&&(0,o.jsx)("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:(0,o.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Email:"})," ",e.user.email]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Role:"})," ",c.get("role")||"Faculty"]})]})}),!m&&(0,o.jsx)("button",{onClick:h,className:"w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors",children:"Go to Dashboard"})]})})})}},3169:(e,r,t)=>{"use strict";t.d(r,{As:()=>c,OJ:()=>i,xf:()=>u});var o=t(5155),s=t(2115),l=t(5695),a=t(2108);t(7383);let n=(0,s.createContext)();function i(e){let{children:r}=e,{data:t,status:i}=(0,a.useSession)(),[c,u]=(0,s.useState)(null),[d,h]=(0,s.useState)(!0),g=(0,l.useRouter)();(0,s.useEffect)(()=>{if("loading"===i)return void h(!0);(null==t?void 0:t.user)?u({id:t.user.id,name:t.user.name,email:t.user.email,image:t.user.image,role:t.user.role,department:t.user.department,employeeId:t.user.employeeId}):u(null),h(!1)},[t,i]);let m=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"google";try{let r=await (0,a.signIn)(e,{callbackUrl:f(null==c?void 0:c.role)||"/"});return{success:!0,result:r}}catch(e){return console.error("Login error:",e),{success:!1,error:"Login failed"}}},p=async()=>{try{await (0,a.signOut)({callbackUrl:"/login"})}catch(e){console.error("Logout error:",e)}},f=e=>{switch(e){case"admin":return"/admin";case"hod":return"/hod";case"security_head":return"/securityincharge";case"security":return"/security";case"faculty":return"/faculty";default:return"/"}};return(0,o.jsx)(n.Provider,{value:{user:c,loading:d||"loading"===i,login:m,logout:p,hasRole:e=>{if(!(null==c?void 0:c.role))return!1;let r={admin:4,security_head:3,hod:2,security:1,faculty:1};return(r[c.role]||0)>=(r[e]||0)},hasAnyRole:e=>!!(null==c?void 0:c.role)&&!!Array.isArray(e)&&e.includes(c.role),isRole:e=>(null==c?void 0:c.role)===e,navigateToDashboard:()=>{let e=f(null==c?void 0:c.role);console.log("\uD83D\uDE80 navigateToDashboard: Navigating to:",{userRole:null==c?void 0:c.role,dashboardUrl:e,userEmail:null==c?void 0:c.email});try{console.log("\uD83D\uDE80 navigateToDashboard: Attempting router.push..."),g.push(e),setTimeout(()=>{console.log("\uD83D\uDE80 navigateToDashboard: Router.push timeout, using window.location fallback"),window.location.href=e},1e3)}catch(r){console.error("\uD83D\uDE80 navigateToDashboard: Router.push failed, using window.location:",r),window.location.href=e}},getDashboardUrl:f,session:t},children:r})}function c(){let e=(0,s.useContext)(n);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}function u(){let[e,r]=(0,s.useState)(!1),[t,o]=(0,s.useState)(null),[l,a]=(0,s.useState)(null);return{loading:e,error:t,scanResult:l,clearError:()=>o(null),clearResult:()=>a(null),scanQRCode:async(e,t,s)=>{r(!0),o(null);try{let r=await fetch("/api/security/scan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({qrData:e,action:"collection",location:t,deviceInfo:s})}),o=await r.json();if(!r.ok)throw Error(o.error||"Failed to process QR code");return a(o),{success:!0,data:o}}catch(r){let e=r.message||"Failed to process QR code";return o(e),{success:!1,error:e}}finally{r(!1)}}}}},9877:(e,r,t)=>{Promise.resolve().then(t.bind(t,3105))}},e=>{e.O(0,[96,358],()=>e(e.s=9877)),_N_E=e.O()}]);